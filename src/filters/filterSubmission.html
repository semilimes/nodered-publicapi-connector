<script type="text/javascript">
    RED.nodes.registerType('filterSubmission', {
        category: 'semilimesAPI',
        color: '#E2D96E',
        defaults: {
            name: { value: "" },
            reference: { value: "" },
            referenceType: { value: "str" },
            messageId: { value: "" },
            messageIdType: { value: "str" },
            saveLocation: { value: "savedSubmission" },
            saveLocationType: { value: "msg"},
            extractValues: { value: true }
        },
        inputs: 1,
        outputs: 1,
        align: 'left',
        icon: "font-awesome/fa-filter",
        paletteLabel: 'Filter - Submission',
        label: function () {
            refType = this.referenceType === "str" ? "" : this.referenceType + ".";
            return this.name ||
                (this.reference ? `Filter Submission | ${refType}${this.reference}`: null) || 
                'Catch All Submissions';
        },
        labelStyle: function () {
            return this.reference ? "node_label_italic" : "";
        },
        oneditsave: function () {
            this.extractValues = $('#node-input-extractValues').prop("checked") == true;
        },
        oneditprepare: function () {
            $('#node-input-extractValues').prop("checked", this.extractValues);

            $("#node-input-reference").typedInput({
                type: "str",
                types: ["str", "msg", "flow", "global"],
                typeField: "#node-input-referenceType"
            });
            $("#node-input-messageId").typedInput({
                type: "str",
                types: ["str", "msg", "flow", "global"],
                typeField: "#node-input-messageIdType"
            });
            $("#node-input-saveLocation").typedInput({
                type: "msg",
                types: ["msg", "flow", "global"],
                typeField: "#node-input-saveLocationType"
            });
        }
    });
</script>

<script type="text/html" data-template-name="filterSubmission">
    <div style="max-width:500px;">When users submit forms, the submissions can be catched by this node and stored to a variable.</div>
    <br />
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-reference"><i class="fa fa-tag"></i> Form Reference</label>
        <input type="text" id="node-input-reference" placeholder="Ref name of the original form">
        <input type="hidden" id="node-input-referenceType">
    </div>
    <div style="font-size: smaller;max-width:500px;">Filter submissions of a specific form, via its reference name</div>
    <br />
    <div class="form-row">
        <label for="node-input-messageId"><i class="fa fa-tag"></i> Message Id</label>
        <input type="text" id="node-input-messageId" placeholder="Original message of the published form">
        <input type="hidden" id="node-input-messageIdType">
    </div>
    <div style="font-size: smaller;max-width:500px;">Filter submissions of a form sent in a specific message, via its message Id</div>
    <br />
    <div class="form-row">
        <label for="node-input-saveLocation"><i class="fa fa-tag"></i> Save Location</label>
        <input type="text" id="node-input-saveLocation" placeholder="Location to save form submission">
        <input type="hidden" id="node-input-saveLocationType">
    </div>
    <div style="font-size: smaller;max-width:500px;">Set this value to extract the submission form</div>
    <br />
    <div class="form-row">
        <label for="node-input-extractValues"> Extract Values</label>
        <input type="checkbox" id="node-input-extractValues" name="extractValues" value="1">
    </div>
    <div style="font-size: smaller;max-width:500px;">Check this to extract each submission value in <code>msg</code> property. Only works if <code>Save Location</code> property is set.</div>
</script>

<script type="text/html" data-help-name="filterSubmission">
    <p>Filter submissions of a specific form via its reference name, and optionally extract submitted values for further processing</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt><code>msg.[Save Location]</code> <span class="property-type">array</span></dt>
        <dd>Returns an object containing the details of the original form reference and message Id ("replyTo" property), and all the form components ("formComponents" property)
            containing their properties and updated values ("value property"). Example object:
            <pre>
{
    "replyTo": {
        "messageId": "...",
        "refName": "myFormReference" 
    },
    "formComponents": [
        {
            "formComponentType": "label",
            "refName": "myLampLabel",
            "title": "Lamp control panel"
        },
        { 
            "formComponentType": "switch",
            "refName": "myLampSwitch",
            "title":"Switch", 
            "value":0, 
            "requiredSelection": false 
        },
        {
            "formComponentType": "slider",
            "refName": "myLampDimmer",
            "title": "Dimmer",
            "value": 8, 
            "requiredSelection": false,
            "min": 0,
            "max": 10,
            "step": 1
        }
    ]
}                
            </pre>
    </dl>
    <h3>Properties</h3>
    <p>
        <b>Form Reference:</b> Only catch submissions that reference this form name (Note: there can be multiple forms with the same reference name and different message Ids)
    </p>
    <p>
        <b>Message Id:</b> Only catch submissions that reference a specific messageId. The combination of this parameter and the Form Reference ensures that the data comes from a single point of truth (e.g. a specific message in a specific channel).
    </p>
    <p>
        <b>Save Location:</b> The destination variable where to send the output of the filtering.
    </p>
</script>
