<script type="text/javascript">
    RED.nodes.registerType('sme-comp-form', {
        category: 'semilimesAPI',
        color: '#a6bbcf',
        defaults: {
            connector: { type: 'sme-main-connector', required: true },
            name: { value: "" },
            submitEnabled: { value: "1"},
            retainStatus: { value: "0" },
            submitText: { value: "Submit" },
            submitTextType: { value: "str"},
            recipientId: { value: "" },
            recipientIdType: { value: "str" },
            groupChatId: { value: "" },
            groupChatIdType: { value: "str" },
            channelId: { value: "" },
            channelIdType: { value: "str" },
            receiverType: { value: "none" },
            refName: { value: "" },
            refNameType: { value: "str" }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-comment-o",
        paletteLabel: 'Form',
        label: function() {
            return this.name || "Form" + (this.refName ? ` | Ref: ${this.refName}`: "");
        },
        oneditprepare: function () {
            $("#node-input-submitText").typedInput({
                type: "str",
                types: ["str", "msg", "flow", "global"],
                typeField: "#node-input-submitTextType"
            });
            $("#node-input-receiverId").typedInput({
                type: "str",
                types: ["str", "msg", "flow", "global"],
                typeField: "#node-input-receiverIdType"
            });
            $("#node-input-refName").typedInput({
                type: "str",
                types: ["str", "msg", "flow", "global"],
                typeField: "#node-input-refNameType"
            });

            updateFormComponentUI();

            //Preparing the search recipients button
            $('#node-config-input-scan-recipients').click(function()
                {
                    if ($('#node-input-recipientId').prop("tagName").toLowerCase() === "input")
                    {
                        searchRecipients(); 
                    }
                }
            );

            function searchRecipients()
            {   
                var current = $('#node-input-recipientId').val();
                $('#node-input-recipientId').replaceWith('<select id="node-input-recipientId" style="width: 100%"></select>');
                $('#node-input-recipientId').append('<option selected="selected" value="null">searching recipients...</option>');

                $.getJSON('sme/recipients')
                .done(function(apiResponse) {
                    console.log(apiResponse.data);

                    var recipients = apiResponse.data ?? [];

                    if (recipients.length <= 0) {
                        RED.notify("No recipients found.", "error");
                    }

                    $('#node-input-recipientId').empty();

                    //SET RECIPIENTS AS OPTIONS
                    recipients.forEach(function(recipient, idx) {
                        $('#node-input-recipientId').append(`<option ${idx == 0 ? " selected='selected'" : ""} value="${recipient.accountId}">${recipient.accountName}</option>`);
                        if (idx == 0) {
                            //SET FIRST VALUE
                            $('#node-input-recipientId').val(recipient.accountId);
                            //Set AutoName for node
                            $('#node-input-autoName').val(`Recipient: "${recipient.accountName}"`);
                        }
                    });
                    updateFormComponentUI();
                })
                .fail(function()
                {
                    RED.notify("Something went wrong. Please retry.", "error");
                });
            }

            //Preparing the search groupChats button
            $('#node-config-input-scan-groupChats').click(function()
                {
                    if ($('#node-input-groupChatId').prop("tagName").toLowerCase() === "input")
                    {
                        searchGroupChats(); 
                    }
                }
            );

            function searchGroupChats()
            {   
                var current = $('#node-input-groupChatId').val();
                $('#node-input-groupChatId').replaceWith('<select id="node-input-groupChatId" style="width: 100%"></select>');
                $('#node-input-groupChatId').append('<option selected="selected" value="null">searching group chats...</option>');

                $.getJSON('sme/groupChats')
                .done(function(apiResponse) {
                    console.log(apiResponse.data);

                    var groupChats = apiResponse.data ?? [];

                    if (groupChats.length <= 0) {
                        RED.notify("No group chats found.", "error");
                    }

                    $('#node-input-groupChatId').empty();
                    
                    //SET GROUPCHATS AS OPTIONS
                    groupChats.forEach(function(chat, idx) {
                        $('#node-input-groupChatId').append(`<option ${idx == 0 ? " selected='selected'" : ""} value="${chat.groupChatId}">${chat.title}</option>`);
                        if (idx == 0) {
                            //SET FIRST VALUE
                            $('#node-input-groupChatId').val(chat.groupChatId);
                            //Set AutoName for node
                            $('#node-input-autoName').val(`Group Chat: "${chat.title}"`);
                        }
                    });
                    updateFormComponentUI();
                })
                .fail(function()
                {
                    RED.notify("Something went wrong. Please retry.", "error");
                });
            }

            //Preparing the search channels button
            $('#node-config-input-scan-channels').click(function()
                {
                    if ($('#node-input-channelId').prop("tagName").toLowerCase() === "input")
                    {
                        searchChannels(); 
                    }
                }
            );

            function searchChannels()
            {   
                var current = $('#node-input-channelId').val();
                $('#node-input-channelId').replaceWith('<select id="node-input-channelId" style="width: 100%"></select>');
                $('#node-input-channelId').append('<option selected="selected" value="null">searching channels...</option>');

                $.getJSON('sme/channels')
                .done(function(apiResponse) {
                    console.log(apiResponse.data);

                    var channels = apiResponse.data ?? [];

                    if (channels.length <= 0) {
                        RED.notify("No channels found.", "error");
                    }

                    $('#node-input-channelId').empty();
                    //SET CHANNELS AS OPTIONS
                    channels.forEach(function(channel, idx) {
                        $('#node-input-channelId').append(`<option ${idx == 0 ? " selected='selected'" : ""} value="${channel.channelId}">${channel.title}</option>`);
                        if (idx == 0) {
                            //SET FIRST VALUE
                            $('#node-input-channelId').val(channel.channelId);
                            //Set AutoName for node
                            $('#node-input-autoName').val(`Channel: "${channel.title}"`);
                        }
                    });
                    updateFormComponentUI();
                })
                .fail(function()
                {
                    RED.notify("Something went wrong. Please retry.", "error");
                });
            }
        }
    });

    
    function updateFormComponentUI() {
        var receiverType = $('#node-input-receiverType').val();
        var submitEnabled = $('#node-input-submitEnabled').val();

        if (submitEnabled == "0") {
            $('#node-input-submitTextPanel').hide();
        } else {
            $('#node-input-submitTextPanel').show();
        }

        switch (receiverType) {
            case 'none':
                $('#node-input-recipientIdPanel').hide();
                $('#node-input-groupChatIdPanel').hide();
                $('#node-input-channelIdPanel').hide();
                break;
            case 'contact':
                $('#node-input-recipientIdPanel').show();
                $('#node-input-groupChatIdPanel').hide();
                $('#node-input-channelIdPanel').hide();
                break;
            case 'groupchat':
                $('#node-input-recipientIdPanel').hide();
                $('#node-input-groupChatIdPanel').show();
                $('#node-input-channelIdPanel').hide();
                break;
            case 'channel':
                $('#node-input-recipientIdPanel').hide();
                $('#node-input-groupChatIdPanel').hide();
                $('#node-input-channelIdPanel').show();
                break;                
        }
    }
    

</script>

<script type="text/html" data-template-name="sme-comp-form">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name"/>
    </div>
    <br />
    <div class="form-row">
        <label for="node-input-connector"><i class="fa fa-cog"></i> Connector</label>
        <input type="text" id="node-input-connector" placeholder="semilimes connector" />
    </div>
    <div style="font-size: smaller;max-width:500px;">Connector can be shared with other nodes.</div>
    <br />
    <div class="form-row">
        <label for="node-input-refName"><i class="fa fa-tag"></i>Form Reference Name</label>
        <input type="text" id="node-input-refName" placeholder="Reference Name">
        <input type="hidden" id="node-input-refNameType">
    </div>
    <div style="font-size: smaller;max-width:500px;">Compile this for giving this form schema a name you can refer to in other parts of the flow</div>
    <div class="form-row">
        <label for="node-input-submitEnabled"><i class="fa fa-tag"></i>Submit Enabled</label>
        <select id="node-input-submitEnabled" onchange="updateFormComponentUI()">
            <option value="0">No</option>
            <option value="1" selected>Yes</option>
        </select>
    </div>
    <div class="form-row" id="node-input-submitTextPanel">
        <label for="node-input-submitText"><i class="fa fa-tag"></i> Submit Text</label>
        <input type="text" id="node-input-submitText" placeholder="Submit button text">
        <input type="hidden" id="node-input-submitTextType">
    </div>
    <div class="form-row">
        <label for="node-input-retainStatus"><i class="fa fa-tag"></i>Retain Status</label>
        <select id="node-input-retainStatus">
            <option value="0" selected>No</option>
            <option value="1">Yes</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-receiverType"><i class="fa fa-tag"></i>Receiver Type</label>
        <select id="node-input-receiverType" onchange="updateFormComponentUI()">
            <option value="none" selected> - </option>
            <option value="contact">Contact</option>
            <option value="groupchat">Group Chat</option>
            <option value="channel">Channel</option>
        </select>
    </div>
    <div class="form-row" id="node-input-recipientIdPanel">
        <label for="node-input-recipientId"> Contact Id</label>
        <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
            <div style="position: absolute; left: 0px; right: 40px;">
                <input type="text" id="node-input-recipientId" placeholder="Recipient Id" style="width: 100%">
                <input type="hidden" id="node-input-recipientIdType">
            </div>
            <a id="node-config-input-scan-recipients" class="editor-button" style="position: absolute; right: 0px; top: 0px;">
                <i class="fa fa-search"></i>
            </a>
        </div>
    </div>
    <div class="form-row" id="node-input-groupChatIdPanel">
        <label for="node-input-groupChatId"> Group Chat Id</label>
        <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
            <div style="position: absolute; left: 0px; right: 40px;">
                <input type="text" id="node-input-groupChatId" placeholder="Group Chat Id" style="width: 100%"/>
                <input type="hidden" id="node-input-groupChatIdType">
            </div>
            <a id="node-config-input-scan-groupChats" class="editor-button" style="position: absolute; right: 0px; top: 0px;">
                <i class="fa fa-search"></i>
            </a>
        </div>
    </div>
    <div class="form-row" id="node-input-channelIdPanel">
        <label for="node-input-channelId">Channel Id</label>
        <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
            <div style="position: absolute; left: 0px; right: 40px;">
                <input type="text" id="node-input-channelId" placeholder="Channel Id" style="width: 100%"/>
                <input type="hidden" id="node-input-channelIdType">
            </div>
            <a id="node-config-input-scan-channels" class="editor-button" style="position: absolute; right: 0px; top: 0px;">
                <i class="fa fa-search"></i>
            </a>
        </div>
    </div>

    <div class="form-tips">
        <span>This node <b>must</b> be used in combination and <b>before</b> any <code>form component</code> nodes</span>
    </div>
</script>



<script type="text/html" data-help-name="sme-comp-form">
    <p>
        This node creates a form message skeleton. 
        When you want to send a form message, you have to setup this node first, 
        and then add other form components blocks (labels, switches, ...) to compose the final form before sending.
    </p>
    <h3>Properties</h3>
    <p>
        <b>Form Reference Name:</b> this assigns a name to the form when being sent.
        The semilimes server will send back this name whenever this form is submitted, hence this name is necessary
        whenever you want to listen to (and filter) form submissions.
    </p>
    <br/>
    <p>
        <b>Submit Enabled:</b> if set to <i>Yes</i>, the form published on the semilimes app will have an explicit submit button.
        This is particularly useful when a semilimes user wants to setup text fields or multiple values in the form before submitting it.
        If set to <i>No</i>, the published form will be automatically submitted on each value change. This option can be used, for example,
        when a form resembles a control panel, so that the user only has to press buttons / toggle switches/ change sliders.
    </p>
    <p>
        <b>Submit Text:</b> this is the custom text assigned to the Submit button in the form (if enabled).
    </p>
    <p>
        <b>Retain Status:</b> if set to <i>Yes</i>, the published form on the semilimes app, upon submission, will maintain the latest set values.
        This is particularly useful if the form is used as a control panel, so that every user can see what is the latest status of the form.
        If set to <i>No</i>, the form will be reset to its default values. This option can be used, for example, when the form is used as a data collector.
        In this case, each user will enter its data and submit, then the form will come back to its original state for the next collection.
    </p>
    <p>
        <b>Receiver Type:</b> this option lets you determine where the form submission values are sent. 
        If you don't specify a receiver, each submission result will be sent to a private chat between your account and the submitter's account.
        If you specify a receiver, you can choose who is going to receive the submission among Contacts, Group Chats, and Channels.
    </p>
    <h3>Details</h3>
    <p>If you debug the output of this node (complete msg object), you will find a new message in the sending array (<code>msg._sme.sendingMsgs[]</code>), like the schema below.
        The schema is not yet complete for sending, because it requires actual data fields (<code>"formComponents"</code>) to be added after this node.
        <pre>
{
    "dataComponent": {
        "dataComponentType":"form",
        "submitEnabled":true,
        "submitText":"Submit",
        "formComponents":[],
        "retainStatus":false,
        "receiver":{},
        "refName":null
    }
}
        </pre>
    </p>
    <h3>References</h3>
    <ul>
        <li><a href="https://www.semilimes.com/developers/" target="_blank">API documentation</a> - full description of messages and their components.</li>
        <li><a href="https://github.com/semilimes/nodered-publicapi-connector" target="_blank">GitHub</a> - the nodes github repository</li>
    </ul>
</script>