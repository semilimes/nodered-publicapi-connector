<script type="text/javascript">
    RED.nodes.registerType('sme-main-intent', {
        category: 'semilimesAPI',
        color: '#E2D96E',
        defaults: {
            name: { value: "" },
            autoName: { value: "" },
            connector: { type: 'sme-main-connector', required: true },
            actionName: { value: "" },
            actionText: { value: "" },

            recipientId: { value: "" },
            recipientIdType: { value: "str" },

            messageId: { value: "" },
            messageIdType: { value: "str" },

            limit: { value: 0 },
            limitType: { value: "num" },

            recipientIds: { value: "" },
            recipientIdsType: { value: "str" },

            groupChatId: { value: "" },
            groupChatIdType: { value: "str" },

            channelId: { value: "" },
            channelIdType: { value: "str" },

            title: { value: ""},
            titleType: {value: "str"}
        },
        inputs: 1,
        outputs: 1,
        align: 'left',
        icon: "font-awesome/fa-arrows-alt",
        label: function() {
            return this.name || `Intent: ${this.actionText ?? "?"}${this.actionText && this.autoName ? " | " + this.autoName : ""}`;
        },
        labelStyle: function () {
            return this.actionName ? "node_label_italic" : "";
        },
        paletteLabel: 'Intent',
        oneditsave: function() {
            this.autoName = $('#node-input-autoName').val();
        },
        oneditprepare: function () {
            $("#node-input-recipientId").typedInput({
                type: "str",
                types: ["str", "msg", "flow", "global"],
                typeField: "#node-input-recipientIdType"
            });

            $("#node-input-messageId").typedInput({
                type: "str",
                types: ["str", "msg", "flow", "global"],
                typeField: "#node-input-messageIdType"
            });

            $("#node-input-limit").typedInput({
                type: "num",
                types: ["num", "msg", "flow", "global"],
                typeField: "#node-input-limitType"
            });

            $("#node-input-recipientIds").typedInput({
                type: "str",
                types: ["str", "msg", "flow", "global"],
                typeField: "#node-input-recipientIdsType"
            });

            $("#node-input-groupChatId").typedInput({
                type: "str",
                types: ["str", "msg", "flow", "global"],
                typeField: "#node-input-groupChatIdType"
            });

            $("#node-input-channelId").typedInput({
                type: "str",
                types: ["str", "msg", "flow", "global"],
                typeField: "#node-input-channelIdType"
            });

            $("#node-input-title").typedInput({
                type: "str",
                types: ["str", "msg", "flow", "global"],
                typeField: "#node-input-titleType"
            });

            updateUI2();

            //Preparing the search recipients button
            $('#node-config-input-scan-recipients').click(function()
                {
                    if ($('#node-input-recipientId').prop("tagName").toLowerCase() === "input")
                    {
                        searchRecipients(); 
                    }
                }
            );

            function searchRecipients()
            {   
                var current = $('#node-input-recipientId').val();
                $('#node-input-recipientId').replaceWith('<select id="node-input-recipientId" style="width: 100%"></select>');
                $('#node-input-recipientId').append('<option selected="selected" value="null">searching recipients...</option>');

                $.getJSON('sme/recipients')
                .done(function(apiResponse) {
                    console.log(apiResponse.data);

                    var recipients = apiResponse.data ?? [];

                    if (recipients.length <= 0) {
                        RED.notify("No recipients found.", "error");
                    }

                    $('#node-input-recipientId').empty();

                    //SET RECIPIENTS AS OPTIONS
                    recipients.forEach(function(recipient, idx) {
                        $('#node-input-recipientId').append(`<option ${idx == 0 ? " selected='selected'" : ""} value="${recipient.accountId}">${recipient.accountName}</option>`);
                        if (idx == 0) {
                            //SET FIRST VALUE
                            $('#node-input-recipientId').val(recipient.accountId);
                            //Set AutoName for node
                            $('#node-input-autoName').val(`Recipient: "${recipient.accountName}"`);
                        }
                    });
                    updateUI2();
                })
                .fail(function()
                {
                    RED.notify("Something went wrong. Please retry.", "error");
                });
            }

            $(document).on('change', '#node-input-recipientId', function()
            {
                var recipientName = $('#node-input-recipientId option:selected').text();
                if (recipientName) {
                    $('#node-input-autoName').val(recipientName.length > 0 ? `Recipient: "${recipientName}"` : "");
                    updateUI2();
                }
            });

            //Preparing the search groupChats button
            $('#node-config-input-scan-groupChats').click(function()
                {
                    if ($('#node-input-groupChatId').prop("tagName").toLowerCase() === "input")
                    {
                        searchGroupChats(); 
                    }
                }
            );

            function searchGroupChats()
            {   
                var current = $('#node-input-groupChatId').val();
                $('#node-input-groupChatId').replaceWith('<select id="node-input-groupChatId" style="width: 100%"></select>');
                $('#node-input-groupChatId').append('<option selected="selected" value="null">searching group chats...</option>');

                $.getJSON('sme/groupChats')
                .done(function(apiResponse) {
                    console.log(apiResponse.data);

                    var groupChats = apiResponse.data ?? [];

                    if (groupChats.length <= 0) {
                        RED.notify("No group chats found.", "error");
                    }

                    $('#node-input-groupChatId').empty();
                    
                    //SET GROUPCHATS AS OPTIONS
                    groupChats.forEach(function(chat, idx) {
                        $('#node-input-groupChatId').append(`<option ${idx == 0 ? " selected='selected'" : ""} value="${chat.groupChatId}">${chat.title}</option>`);
                        if (idx == 0) {
                            //SET FIRST VALUE
                            $('#node-input-groupChatId').val(chat.groupChatId);
                            //Set AutoName for node
                            $('#node-input-autoName').val(`Group Chat: "${chat.title}"`);
                        }
                    });
                    updateUI2();
                })
                .fail(function()
                {
                    RED.notify("Something went wrong. Please retry.", "error");
                });
            }

            $(document).on('change', '#node-input-groupChatId', function()
            {
                var chatName = $('#node-input-groupChatId option:selected').text();
                if (chatName) {
                    $('#node-input-autoName').val(chatName.length > 0 ? `Group Chat: "${chatName}"` : "");
                    updateUI2();
                }
            });

            //Preparing the search channels button
            $('#node-config-input-scan-channels').click(function()
                {
                    if ($('#node-input-channelId').prop("tagName").toLowerCase() === "input")
                    {
                        searchChannels(); 
                    }
                }
            );

            function searchChannels()
            {   
                var current = $('#node-input-channelId').val();
                $('#node-input-channelId').replaceWith('<select id="node-input-channelId" style="width: 100%"></select>');
                $('#node-input-channelId').append('<option selected="selected" value="null">searching channels...</option>');

                $.getJSON('sme/channels')
                .done(function(apiResponse) {
                    console.log(apiResponse.data);

                    var channels = apiResponse.data ?? [];

                    if (channels.length <= 0) {
                        RED.notify("No channels found.", "error");
                    }

                    $('#node-input-channelId').empty();
                    //SET CHANNELS AS OPTIONS
                    channels.forEach(function(channel, idx) {
                        $('#node-input-channelId').append(`<option ${idx == 0 ? " selected='selected'" : ""} value="${channel.channelId}">${channel.title}</option>`);
                        if (idx == 0) {
                            //SET FIRST VALUE
                            $('#node-input-channelId').val(channel.channelId);
                            //Set AutoName for node
                            $('#node-input-autoName').val(`Channel: "${channel.title}"`);
                        }
                    });
                    updateUI2();
                })
                .fail(function()
                {
                    RED.notify("Something went wrong. Please retry.", "error");
                });
            }

            $(document).on('change', '#node-input-channelId', function()
            {
                var channelName = $('#node-input-channelId option:selected').text();
                if (channelName) {
                    $('#node-input-autoName').val(channelName.length > 0 ? `Channel: "${channelName}"` : "");
                }
                updateUI2();
            });
        }
    });

    function updateUI2() {
        var actionName = $('#node-input-actionName').val();
        $('#node-input-actionText').val(
            $('#node-input-actionName option:selected').text()
        );
        this.actionText = $('#node-input-actionText').val();
        
        //hide all panels
        $('#node-input-recipientIdPanel').hide();
        $('#node-input-messageIdPanel').hide();
        $('#node-input-limitPanel').hide();
        $('#node-input-titlePanel').hide();
        $('#node-input-recipientIdsPanel').hide();
        $('#node-input-groupChatIdPanel').hide();
        $('#node-input-channelIdPanel').hide();

        switch (actionName) {
            case 'account_contacts': {
                break;
            }
            case 'p2p': {
                //No parameters
                break;
            }
            case 'p2p_message': {
                $('#node-input-recipientIdPanel').show();
                $('#node-input-messageIdPanel').show();
                $('#node-input-limitPanel').show();
                break;
            }
            case 'p2p_message_send': {
                $('#node-input-recipientIdPanel').show();
                break;
            }
            case 'p2p_message_update': {
                $('#node-input-messageIdPanel').show();
                break;
            }
            case 'groupchat': {
                $('#node-input-recipientIdsPanel').show();
                break;
            }
            case 'groupchat_create': {
                $('#node-input-titlePanel').show();
                $('#node-input-recipientIdsPanel').show();
                break;
            }
            case 'groupchat_message': {
                $('#node-input-groupChatIdPanel').show();
                $('#node-input-messageIdPanel').show();
                $('#node-input-limitPanel').show();
                break;
            }
            case 'groupchat_message_send': {
                $('#node-input-groupChatIdPanel').show();
                break;
            }
            case 'groupchat_message_update': {
                $('#node-input-messageIdPanel').show();
                break;
            }
            case 'channel_my': {
                //No parameters
                break;
            }
            case 'channel_create': {
                $('#node-input-titlePanel').show();
                break;
            }
            case 'channel_message_send': {
                $('#node-input-channelIdPanel').show();
                break;
            }
            case 'channel_message_update': {
                $('#node-input-messageIdPanel').show();
                break;
            }
            default: {
                break;
            }
        }
    }
</script>

<script type="text/html" data-template-name="sme-main-intent">
    <div style="max-width:500px;">To interact with the semilimes API, you have to select an intent to execute (aka calling an API endpoint). The data components defined in the flow will be attached to this intent.</div>
    <div style="max-width:500px;">To actually execute the request to the server, use the <code>sender</code> node after this one.</div>
    <br />
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-cog"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="" />
        <input type="hidden" id="node-input-autoName">
    </div>
    <br />
    <div class="form-row">
        <label for="node-input-connector"><i class="fa fa-cog"></i> Connector</label>
        <input type="text" id="node-input-connector" placeholder="semilimes connector" />
    </div>
    <div style="font-size: smaller;max-width:500px;">Connector can be shared with other nodes.</div>
    <br />
    <div class="form-row">
        <label for="node-input-actionName"><i class="fa fa-cog"></i> <span> Intent</span></label>
        <select id="node-input-actionName" onchange="updateUI2()">
            <option value="account_contacts">Account - Get Contacts</option>
            <option value="p2p">P2P - Get Chats</option>
            <option value="p2p_message">P2P - Get Messages</option>
            <option value="p2p_message_send">P2P - Send Message</option>
            <option value="p2p_message_update">P2P - Update Message</option>
            <option value="groupchat">GroupChat - Get Chats</option>
            <option value="groupchat_create">GroupChat - Create</option>
            <option value="groupchat_message">GroupChat - Get Messages</option>
            <option value="groupchat_message_send">GroupChat - Send Message</option>
            <option value="groupchat_message_update">GroupChat - Update Message</option>
            <option value="channel_my">Channel - My Channels</option>
            <option value="channel_create">Channel - Create</option>
            <option value="channel_message_send">Channel - Send Message</option>
            <option value="channel_message_update">Channel - Update Message</option>
        </select>
        <input type="hidden" id="node-input-actionText">
    </div>
    <div class="form-row" id="node-input-recipientIdPanel">
        <label for="node-input-recipientId"> Recipient Id</label>
        <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
            <div style="position: absolute; left: 0px; right: 40px;">
                <input type="text" id="node-input-recipientId" placeholder="Recipient Id" style="width: 100%">
                <input type="hidden" id="node-input-recipientIdType">
            </div>
            <a id="node-config-input-scan-recipients" class="editor-button" style="position: absolute; right: 0px; top: 0px;">
                <i class="fa fa-search"></i>
            </a>
        </div>
    </div>
    <div class="form-row" id="node-input-titlePanel">
        <label for="node-input-title"> Title</label>
        <input type="text" id="node-input-title" placeholder="Title">
        <input type="hidden" id="node-input-titleType">
    </div>
    <div class="form-row" id="node-input-recipientIdsPanel">
        <label for="node-input-recipientIds">Recipient Ids</label>
        <input type="text" id="node-input-recipientIds" placeholder="Recipient Ids">
        <input type="hidden" id="node-input-recipientIdsType">
        <div style="font-size: smaller;max-width:500px;">Enter comma-separated recipients if multiple</div>
    </div>
    <div class="form-row" id="node-input-groupChatIdPanel">
        <label for="node-input-groupChatId"> Group Chat Id</label>
        <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
            <div style="position: absolute; left: 0px; right: 40px;">
                <input type="text" id="node-input-groupChatId" placeholder="Group Chat Id" style="width: 100%"/>
                <input type="hidden" id="node-input-groupChatIdType">
            </div>
            <a id="node-config-input-scan-groupChats" class="editor-button" style="position: absolute; right: 0px; top: 0px;">
                <i class="fa fa-search"></i>
            </a>
        </div>
    </div>
    <div class="form-row" id="node-input-channelIdPanel">
        <label for="node-input-channelId">Channel Id</label>
        <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
            <div style="position: absolute; left: 0px; right: 40px;">
                <input type="text" id="node-input-channelId" placeholder="Channel Id" style="width: 100%"/>
                <input type="hidden" id="node-input-channelIdType">
            </div>
            <a id="node-config-input-scan-channels" class="editor-button" style="position: absolute; right: 0px; top: 0px;">
                <i class="fa fa-search"></i>
            </a>
        </div>
    </div>
    <div class="form-row" id="node-input-messageIdPanel">
        <label for="node-input-messageId"> Message Id</label>
        <input type="text" id="node-input-messageId" placeholder="Message Id">
        <input type="hidden" id="node-input-messageIdType">
    </div>
    <div class="form-row" id="node-input-limitPanel">
        <label for="node-input-limit"> Limit</label>
        <input type="text" id="node-input-limit" placeholder="Limit">
        <input type="hidden" id="node-input-limitType">
    </div>
</script>

<script type="text/x-red" data-help-name="sme-main-intent">
    <p>Set recipient to the input messages.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt><code>msg.payload</code> <span class="property-type">sme-message</span></dt>
        <dd>Must contain a valid semilimes payload according to the selected intent.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt><code>msg.payload</code> <span class="property-type">sme-message</span></dt>
        <dd>Returns the compiled request to be sent via the <code>sender</code> node.</dd>
    </dl>
    <h3>References</h3>
    <ul>
        <li><a href="https://www.semilimes.com/developers/">API documentation</a> - full description of messages and their components.</li>
        <li><a href="https://github.com/semilimes/nodered-publicapi-connector">GitHub</a> - the nodes github repository</li>
    </ul>
</script>